<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html" lang="en">

<head>
    <link rel="stylesheet" type="text/css" href="/resources/bootstrap-5.0.2/css/bootstrap.min.css">
    <script src="/resources/bootstrap-5.0.2/js/bootstrap.bundle.min.js"></script>
    <th:block th:replace="/ohana/layout/head :: head('Ohana - Tìm ở ghép, phòng trọ siêu nhanh')"/>
    <style>
        .col-md-3 {
            float: left;
        }

        .pd-25 {
            padding-left: 50px;
            padding-right: 50px;
        }

        .pd {
            padding: 10px;
        }

        /*    css upload file*/
        .image_container {
            height: 120px;
            width: 200px;
            border-radius: 6px;
            overflow: hidden;
            margin: 10px;
        }

        .image_container img {
            height: 100%;
            width: auto;
            object-fit: cover;
        }

        .image_container span {
            top: -6px;
            right: 8px;
            color: red;
            font-size: 28px;
            font-weight: normal;
            cursor: pointer;
        }

        .img_avatar {
            height: 120px;
            width: 200px;
        }

        /*.cover-image {*/
        /*    position: absolute;*/
        /*    bottom: -10px;*/
        /*    background-image: linear-gradient(rgba(206, 141, 206, 0.91), #f517e9);*/
        /*}*/

        /*.position-relative {*/
        /*    position: relative;*/
        /*}*/

    </style>


</head>

<body data-new-gr-c-s-check-loaded="14.1057.0" data-gr-ext-installed="" cz-shortcut-listen="true">
<th:block th:replace="/ohana/layout/modal/modal-loading :: modal-loading"/>
<div class="container">
    <div class="_3bjUj ">
        <!--header-->
        <th:block th:replace="/ohana/layout/header :: header(${userLogin})"/>
    </div>

    <div class="_2fxFG" id="divCreate">

        <form class="change_pass" id="form-changepass" action="https://www.webike.vn/account/change-password.html" method="post">
            <input type="hidden" id="_token" name="_token" value="g8ffYBeg1zI5Ij4rn7gQT3RjfxdBXgiZBB61wjZ6">


            <div class="form-group">
                <div class="row-group">
                    <label class="cell-group">Mật khẩu hiện tại *</label>
                    <div class="cell-group">
                        <input id="old_passwd" name="passwd" type="password" class="form-control">
                    </div>
                </div>
            </div>
            <div class="form-group">
                <div class="row-group">
                    <label class="cell-group">Mật khẩu mới *</label>
                    <div class="cell-group">
                        <input name="newpass" type="password" class="form-control">
                    </div>
                </div>
            </div>
            <div class="form-group">
                <div class="row-group">
                    <label class="cell-group">Xác nhận mật khẩu *</label>
                    <div class="cell-group">
                        <input name="confirmPasswd" type="password" class="form-control">
                    </div>
                </div>
            </div>
            <div class="form-group">
                <div class="row-group">
                    <label class="cell-group"></label>
                    <div class="cell-group">
                        <button type="submit" class="btn btn-block btn-danger">Cập nhật</button>
                    </div>
                </div>
            </div>
        </form>

    </div>



    <!--</div>-->
</div>
<th:block th:replace="/ohana/layout/footer :: footer"/>

<th:block th:replace="/ohana/layout/script :: script"/>
<script>
    $(".view-avatar").change(function () {
        const src = URL.createObjectURL(this.files[0]);
        this.parentElement.getElementsByClassName('img-preview')[0].src = src;
    })
</script>
<script>


    let page = {
        url: {
            getAllPendingReview: App.BASE_URL_API + "/posts/list-post-pending-review",
            getAllCategories: App.BASE_URL_API + "/categories",
            getAllUtilities: App.BASE_URL_API + "/utilities",
            getAllGenders: App.BASE_URL_API + "/genders",
            getAllProvinces: App.BASE_URL_PROVINCE,
            doCreatePost: App.BASE_URL_API + "/posts/post-news",
            doCreatePreview: App.BASE_URL_API + "/posts/post-preview",

        },
        element: {},
        loadData: {},
        commands: {},
        initializeControlEvent: {}

    }

    let post = new Post();
    let postDTO = new PostDTO();
    let rentHouseDTO = new RentHouseDTO();
    // let userDTO = new UserDTO();
    let locationDTO = new LocationDTO();
    let form = new FormData();

    let thisOnclick;
    $("#btnCreate, #btnPreview").on("click", (e) => {


        rentHouseDTO.capacity = +$("#capacity").val();
        rentHouseDTO.gender = +$('input[type="radio"][name="gender"]:checked').val();
        rentHouseDTO.area = $("#area").val();
        rentHouseDTO.price = +$("#price").val();

        locationDTO.provinceId = $("#province").val();
        locationDTO.provinceName = $("#province").find('option:selected').text();
        locationDTO.districtId = $("#district").val();
        locationDTO.districtName = $("#district").find('option:selected').text();
        locationDTO.wardId = $("#ward").val();
        locationDTO.wardName = $("#ward").find('option:selected').text();
        locationDTO.locationDetail = $("#locationDetail").val();

        postDTO.title = $("#title").val();
        postDTO.categoryId = +$('input[type="radio"][name="kindOfRoom"]:checked').val();
        postDTO.description = $("#description").val();
        postDTO.location = locationDTO;
        postDTO.rentHouse = rentHouseDTO;
        //poster
        postDTO.poster = 1;
        postDTO.thumbnail = imageCover;
        postDTO.images = imageAdds;
        let favorite = [];
        $.each($("input[name='utilitiesCheckbox']:checked"), function () {
            favorite.push(+$(this).val());
        });

        postDTO.utilities = favorite;

        // $("#frmCreate").validate().resetForm();
        // $("#frmCreate").get(0).reset();
        // $("#frmCreate input").removeClass('error');
        // $("#frmCreate .modal-alert-danger").removeClass('show').addClass('hide').empty();
        thisOnclick = $(e.target);
        $("#frmCreate").submit();

        // loading();


    })

    function doCreatePost(post) {

        $("#loadingModal").modal("show");
        $.ajax({
            type: "POST",
            url: page.url.doCreatePost,
            cache: false,
            contentType: false,
            processData: false,
            data: post
        }).done(function (mess) {
            $("#loadingModal").modal("hide");
            // location.href = App.DOMAIN+"/list-post-published";
            showSuccess(mess)
        }).fail(function (x) {
            $("#loadingModal").modal("hide").then(function () {
                showError("Thêm bài viết không thành công")
            });

            // let str = ``;
            // if (jqXHR.responseJSON) {
            //     if (jqXHR.responseJSON.message) {
            //         str += `<label id="message-error" class="error" for="message">${jqXHR.responseJSON.message}</lable><br>`;
            //     } else {
            //         $.each(jqXHR.responseJSON, function (key, value) {
            //             str += `<label id="${key}-error" class="error" for="${key}">${value}</lable><br>`;
            //             $("#" + key).addClass("error");
            //         });
            //     }
            // } else {
            //     str += `<label id= "message-error" class= "error" for= "message">${App.ERROR_400}</label>`;
            // }
            // $("#createModal .modal-alert-danger").removeClass('hide').addClass('show').html(str);
        })
    }

    function doCreatePreview(post) {
        $("#loadingModal").modal("show");
        $.ajax({
            type: "POST",
            url: page.url.doCreatePreview,
            cache: false,
            contentType: false,
            processData: false,
            data: post
        }).done(function (data) {
            $("#loadingModal").modal("hide");
            location.href = App.DOMAIN + "/ohana/room-preview/" + data;
        }).fail(function (x) {
            $("#loadingModal").modal("hide");
            showError("Xem trước không thành công")
            // let str = ``;
            // if (jqXHR.responseJSON) {
            //     if (jqXHR.responseJSON.message) {
            //         str += `<label id="message-error" class="error" for="message">${jqXHR.responseJSON.message}</lable><br>`;
            //     } else {
            //         $.each(jqXHR.responseJSON, function (key, value) {
            //             str += `<label id="${key}-error" class="error" for="${key}">${value}</lable><br>`;
            //             $("#" + key).addClass("error");
            //         });
            //     }
            // } else {
            //     str += `<label id= "message-error" class= "error" for= "message">${App.ERROR_400}</label>`;
            // }
            // $("#createModal .modal-alert-danger").removeClass('hide').addClass('show').html(str);
        })
    }

    page.commands.getAllCategories = () => {
        $.ajax({
            type: "GET",
            url: page.url.getAllCategories
        }).done(function (data) {
            data.forEach(item => {
                let str = `
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="kindOfRoom" id="kindOfRoom_${item.id}"
                                   value="${item.id}">
                            <label class="form-check-label" for="kindOfRoom_${item.id}">${item.name}</label>
                        </div>
                    `;
                $("#kindOfRoom").append(str);
            });

        }).fail(function () {
            showError('Error')
        })
    }

    page.commands.getAllUtilities = () => {
        $.ajax({
            type: "GET",
            url: page.url.getAllUtilities
        }).done(function (data) {
            data.forEach((item, index) => {
                $('#divUtilities').append(`
                    <div class="col-md-3">
                        <label class="_22Yl9" id="${item.id}">
                            <span class="${item.icon}">
                                <span>${item.name}</span>
                            </span>
                            <input value="${item.id}" type="checkbox" name="utilitiesCheckbox">
                            <span class="_1akYM"></span>
                        </label>
                    </div>
                `);
            });


        }).fail(function () {
            showError('Error')
        })
    }

    page.commands.getAllGenders = () => {
        $.ajax({
            type: "GET",
            url: page.url.getAllGenders
        }).done(function (data) {
            data.forEach((item) => {
                let str = `  <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="gender" id="gender_${item.id}"
                                   value="${item.id}">
                            <label class="form-check-label" for="gender_${item.id}">${item.name}</label>
                        </div>`;
                $("#gender").append(str);
            });
        }).fail(function () {
            showError('Error')
        })
    }

    $("#province").on("change", function () {
        let provinceId = $("#province").val();
        page.commands.getAllDistrict(provinceId).then(() => {
            let districtId = $("#district").val();
            page.commands.getAllWard(districtId);
        });
    })

    $("#district").on("change", function () {
        let districtId = $("#district").val();
        page.commands.getAllWard(districtId);

    })


    page.commands.getAllProvince = () => {
        return $.ajax({
            type: "GET",
            url: page.url.getAllProvinces
        }).done(function (data) {
            // console.log(data)
            let str;
            let provinces = data.results;
            $.each(provinces, (index, item) => {
                str += `
                <option value="${item.province_id}">${item.province_name}</option>
               `;
                $("#province").html(str);
                $("#provinceUp").html(str);
            })

        }).fail(function () {
            showError('Get all provinces fail')
        })
    }

    page.commands.getAllDistrict = (provinceId) => {
        return $.ajax({
            type: "GET",
            url: page.url.getAllProvinces + "/district/" + provinceId
        }).done(function (data) {
            // console.log(data)
            let str;
            let districts = data.results;
            $.each(districts, (index, item) => {
                str += `
                <option value="${item.district_id}">${item.district_name}</option>
               `;
                $("#district").html(str);
                $("#districtUp").html(str);

            })

        }).fail(function () {
            showError('Get all district fail')
        })
    }

    page.commands.getAllWard = (districtId) => {
        $.ajax({
            type: "GET",
            url: page.url.getAllProvinces + "/ward/" + districtId
        }).done(function (data) {
            // console.log(data)
            let str;
            let wards = data.results;
            $.each(wards, (index, item) => {
                str += `
                <option value="${item.ward_id}">${item.ward_name}</option>
               `;
                $("#ward").html(str);
                $("#wardUp").html(str);
            })
        }).fail(function () {
            showError('Get all ward fail')
        })
    }

    page.commands.handleImagePopup = () => {

        $('.image-popup-vertical-fit').magnificPopup({
            type: 'image',
            closeOnContentClick: true,
            mainClass: 'mfp-img',
            image: {
                verticalFit: true
            },
            gallery: {
                enabled: true
            }
        });

        $('.popup-youtube, .popup-vimeo, .popup-gmaps').magnificPopup({
            disableOn: 700,
            type: 'iframe',
            mainClass: 'mfp-fade',
            removalDelay: 160,
            preloader: false,
            fixedContentPos: false
        });
    }

    $("#frmCreate").validate({
        rules: {
            kindOfRoom: {
                required: true
            },
            capacity: {
                required: true,
                min: 1
            },
            gender: {
                required: true,
            },
            area: {
                required: true,
                min: 10
            },
            price: {
                required: true,
                maxlength: 9,
                min: 0
            },
            locationDetail: {
                required: true,
            },
            title: {
                required: true,
                maxlength: 50,
            },
            description: {
                required: true,
                maxlength: 1500,
                minlength: 10,
            },
            coverImage: {
                required: true,
            }
        },
        messages: {

            kindOfRoom: {
                required: "Vui lòng chọn loại phòng</br>"
            },
            capacity: {
                required: "Vui lòng nhập sức chứa",
                min: "Số người phải lớn hơn 0"
            },
            gender: {
                required: "Vui chọn giới tính</br>",
            },
            area: {
                required: "Vui lòng nhập diện tích",
                min: "Diện tích phải lớn hơn 10 m2"
            },
            price: {
                required: "Vui lòng nhập giá",
                maxlength: "Vui lòng nhập giá ít hơn 999.999.999",
                min: "Giá phải từ 0 trở đi",
            },
            locationDetail: {
                required: "Vui lòng nhập địa chỉ cụ thể"
            },
            title: {
                required: "Vui lòng nhập tiêu đề",
                maxlength: "Vui lòng nhập ít hơn 50 kí tự",
            },
            description: {
                required: "Vui lòng nhập mô tả",
                maxlength: "Vui lòng nhập ít hơn 1500 kí tự",
                minlength: "Vui lòng nhập nhiều hơn 10 kí tự",
            },
            coverImage: {
                required: "Vui lòng chọn ảnh bìa",
            }
        }, errorPlacement: function (error, element) {
            if (element.is(":radio") && $(element).attr('id') === "kindOfRoom_1") {
                error.appendTo(element.parents('#kindOfRoom'));
            } else if (element.is(":radio") && $(element).attr('id') === "gender_1") {
                error.appendTo(element.parents('#gender'));
            } else { // This is the default behavior
                error.insertAfter(element);
            }
        },
        // errorLabelContainer: "#frmCreate .modal-alert-danger",
        // errorPlacement: function (error, element) {
        //     error.appendTo("#frmCreate .modal-alert-danger");
        // },
        // showErrors: function (errorMan, errorList) {
        //     if (this.numberOfInvalids() > 0) {
        //         $("#frmCreate .modal-alert-danger").removeClass("hide").addClass("show");
        //     } else {
        //         $("#frmCreate .modal-alert-danger").removeClass("show").addClass("hide").empty();
        //         $("#frmCreate input.error").removeClass("error");
        //     }
        //     this.defaultShowErrors();
        // },
        submitHandler: function () {
            $("#checkQuantityImage").html('');
            if (postDTO.images.length < 5) {
                let str = `<label id="title-error" class="error" for="title">Vui lòng chọn trên 5 ảnh</label>`;
                $("#checkQuantityImage").append(str);
            } else {
                form.append('title', postDTO.title);
                form.append('categoryId', postDTO.categoryId);
                form.append('description', postDTO.description);
                form.append('thumbnail', postDTO.thumbnail);
                postDTO.images.forEach(item => {
                    form.append('images', item);
                });

                form.append('location.provinceId', postDTO.location.provinceId);
                form.append('location.provinceName', postDTO.location.provinceName);
                form.append('location.districtId', postDTO.location.districtId);
                form.append('location.districtName', postDTO.location.districtName);
                form.append('location.wardId', postDTO.location.wardId);
                form.append('location.wardName', postDTO.location.wardName);
                form.append('location.locationDetail', postDTO.location.locationDetail);

                form.append('rentHouse.price', postDTO.rentHouse.price);
                form.append('rentHouse.capacity', postDTO.rentHouse.capacity);
                form.append('rentHouse.area', postDTO.rentHouse.area);
                form.append('rentHouse.genderId', postDTO.rentHouse.gender);

                form.append('poster', postDTO.poster);

                form.append('utilities', postDTO.utilities);
                if (thisOnclick.text() === "Đăng") {
                    doCreatePost(form);
                } else {
                    doCreatePreview(form);
                }
            }


        }
    })

    $("#form").validate({
        rules: {
            image: {
                required: true,
                minlength: 1,
            }
        },
        messages: {
            image: {
                required: "Vui lòng chọn ảnh",
                minlength: "Hiii",
            }
        }, errorPlacement: function (error, element) {
            if (element.is(":radio") && $(element).attr('id') === "kindOfRoom_1") {
                error.appendTo(element.parents('#kindOfRoom'));
            } else if (element.is(":radio") && $(element).attr('id') === "gender_1") {
                error.appendTo(element.parents('#gender'));
            } else { // This is the default behavior
                error.insertAfter(element);
            }
        },
        // errorLabelContainer: "#frmCreate .modal-alert-danger",
        // errorPlacement: function (error, element) {
        //     error.appendTo("#frmCreate .modal-alert-danger");
        // },
        // showErrors: function (errorMan, errorList) {
        //     if (this.numberOfInvalids() > 0) {
        //         $("#frmCreate .modal-alert-danger").removeClass("hide").addClass("show");
        //     } else {
        //         $("#frmCreate .modal-alert-danger").removeClass("show").addClass("hide").empty();
        //         $("#frmCreate input.error").removeClass("error");
        //     }
        //     this.defaultShowErrors();
        // },
        submitHandler: function () {
            alert("oke danh sách ảnh")
        }
    })

    page.loadData = () => {
        page.commands.getAllCategories()
        page.commands.getAllProvince().then(function () {
            let provinceId = $("#province").val();
            page.commands.getAllDistrict(provinceId).then(() => {
                let districtId = $("#district").val();
                page.commands.getAllWard(districtId);

            });
        });
        page.commands.getAllUtilities();
        page.commands.getAllGenders();
    }


    //img
    var imageCover;
    var images = [];
    var imageAdds = [];

    function image_select_cover(el) {
        imageCover = $(el).prop('files')[0];
    }

    function image_select(el) {
        // let form =new FormData();
        // let imageAdd = $(el).prop('files')[0];
        // form.append('images',imageAdd);
        // form.append('images',imageAdd);
        // console.log(imageAdd);
        // doCreatePost(form);
        let image = document.getElementById('image').files;
        for (i = 0; i < image.length; i++) {
            //if (check_duplicate(image[i].name)) {
            images.push({
                "name": image[i].name,
                "url": URL.createObjectURL(image[i]),
                "file": image[i],
            })
            let imageAdd = $(el).prop('files')[i];
            imageAdds.push(imageAdd);
            // } else {
            //      alert(image[i].name + " is already added to the list");
            //  }
        }
        document.getElementById('form').reset();
        document.getElementById('container').innerHTML = image_show();
    }

    function image_show() {
        var image = "";
        images.forEach((i, index) => {
            image += `<div class="image_container d-flex justify-content-center position-relative">
   	  	  	  	  <img class="list-img" src="` + i.url + `" alt="Image">
   	  	  	  	  <span  onclick="delete_image(` + images.indexOf(i) + `)">&times;</span>
   	  	  	  </div>`;

        })
        return image;
    }

    function delete_image(e) {
        images.splice(e, 1);

        imageAdds.splice(e, 1);

        document.getElementById('container').innerHTML = image_show();
    }

    function check_duplicate(name) {
        var image = true;
        if (images.length > 0) {
            for (e = 0; e < images.length; e++) {
                if (images[e].name == name) {
                    image = false;
                    break;
                }
            }
        }
        return image;
    }

    function get_image_data() {
        var form = new FormData()
        let fileReader = new FileReader();
        for (let index = 0; index < images.length; index++) {
            form.append('images', images[index]['file']);
            // fileReader.readAsDataURL(images[index]);
            // form.append("file[" + index + "]", images[index]['file']);
        }

        return form;
    }

    $(function () {
        page.loadData();

    })

</script>
</body>

</html>